## App 的启动方式
1. 冷启动是指，App 点击启动前，它的进程不在系统里，需要系统创建一个进程分配给它。（优化的主要方向）
2. 热启动是指，App 在冷启动后用户将 App 退出后台，在 App 的进程还在系统里的情况下，用户重新启动进入 App 的过程。 


## 冷启动的优化思路
分为三个阶段。  

1. main()函数执行前；
2. main()函数执行后；
3. 首屏渲染完成后。

### main() 函数执行前

包含内容：  
- 加载可执行文件（App .o 文件的集合）；  
- 加载动态链接库，进行 rebase 指针调整和 bind 符号绑定；  
- Objc 运行时的初始处理，包括 Objc 相关类的注册、category 注册、selector 唯一性检查等；  
- 初始化，包括了执行 +load() 方法、attribute((constructor)) 修饰的函数的调用、创建 C++ 静态全局变量。

可优化：  
- 减少动态度加载。（如果动态库较多，可将多个动态库合并。苹果支持最多 6 合一）。
- 减少加载启动后不会去使用的类或者方法。
- +load() 方法里的内容可以放到首屏渲染完成后再执行，或使用 +initialize() 方法替换掉。（+load() 里的运行时方法替换会带来 4 毫秒的消耗）。
-  控制 C++ 全局变量的数量。

### main() 函数执行后
即 main() 函数执行开始，到 appDelegate 的 didFinishLaunchingWithOptions 方法里首屏渲染相关方法执行完成。  

包含内容：  
- 首屏初始化所需配置文件的读写操作；  
- 首屏列表大数据的读取；  
- 首屏渲染的大量计算等；  

可优化：  
从功能上梳理出那些是首屏渲染必要的初始化功能，那些是 App 启动必要的初始化功能，而那些是只需要在对应功能开始使用时才需要初始化的。然后将他们放到合理的阶段执行。  

### 首屏渲染完成
这个阶段指的是截止到 didFinishLaunchingWithOptions 方法作用域内执行首屏渲染之后的所有方法执行完成。  

包含的内容：  
- 非首屏其他业务服务模块的初始化、监听的注册、配置文件的读取等。  

可优化：  
主要是处理那些会卡住主线程的方法。（处在这个阶段时，用户已经能够看到 App 的首页信息了，所以优化的优先级排到最后。）  

## 监控手段

### 一、定时抓取主线程上的方法调用堆栈，计算一段时间里各个方法的耗时  

Xcode 工具套件里自带的 Time Profiler 采用的就是这种方式。这里涉及到了定时抓取的间隔，太短了可能会影响性能，太长了就不准确。一般将这个定时间隔设置为 **0.01** 秒。  

### 二、对 objc_msgSend 方法进行 hook 来掌握所有方法的执行耗时  

优点是非常精确，缺点是只能针对 Objective-C 的方法。对于 C 方法和 block 也不是没有办法，可以使用 libffi 和 ffi_call 来达成 hook。  

这里推荐使用 fishhook，其可以在 iOS 上运行的 Mach-O 二进制文件中动态地重新绑定符号。  

其次需要从汇编的层面加点料。现实两个方法 pushCallRecord 和 popCallRecord，来分别记录 objc_msgSend 方法调用前后的时间。


































